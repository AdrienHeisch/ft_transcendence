FROM oven/bun:1.3.5-debian AS builder
WORKDIR /home/bun/app
COPY package.json .
COPY bun.lock .
COPY svelte.config.ts .
RUN bun ci
COPY . .
COPY .env.example .env
RUN bun run sv:prepare && bun run build

FROM oven/bun:1.3.5-debian
WORKDIR /home/bun/app
COPY container-entrypoint.sh .
RUN chown bun: container-entrypoint.sh
ENTRYPOINT ["./container-entrypoint.sh"]
COPY package.json .
COPY bun.lock .
COPY svelte.config.ts .
COPY drizzle.config.ts .
COPY src/lib/server/db/schema.ts ./src/lib/server/db/schema.ts
COPY --from=builder /home/bun/app/node_modules ./node_modules
COPY --from=builder /home/bun/app/build ./build
USER bun
CMD ["bun", "run", "build/index.js"]
